<?php

/**
 * Implementation of hook_menu().
 */
function acquia_cloud_api_menu() {
  $items['admin/config/cloud-api'] = array(
    'title' => 'Acquia Cloud API Report',
    'description' => 'Report of your Acquia Cloud',
    'page callback' => 'acquia_cloud_api_report',
    'access arguments' => array('access cloud api report'),
  );
  $items['admin/config/cloud-api/configure'] = array(
    'title' => 'Acquia Cloud API Configuration',
    'description' => 'Configuring of your Acquia Cloud',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('acquia_cloud_api_configure_form'),
    'access arguments' => array('configure cloud api'),
  );
  $items['admin/config/cloud-api/add/domain/%/%'] = array(
    'title' => 'Acquia Cloud API Add Domains',
    'description' => 'Add Domains on Acquia Cloud',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('acquia_cloud_api_configure_add_domain_form', 5, 6),
    'access arguments' => array('add domains cloud api'),
    'type' => MENU_CALLBACK,
  );
  $items['admin/config/cloud-api/delete/domain/%/%/%'] = array(
    'title' => 'Acquia Cloud API Delete Domains',
    'description' => 'Delete Domains on Acquia Cloud',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('acquia_cloud_api_configure_delete_domain_form', 5, 6, 7),
    'access arguments' => array('delete domains cloud api'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implementation of hook_permission().
 */
function acquia_cloud_api_permission() {
  return array(
    'access cloud api report' => array(
      'title' => t('Access Cloud API Report'),
      'description' => t('Allows user to access report generated by Cloud API module for the subscription'),
    ),
    'configure cloud api' => array(
      'title' => t('Configure Cloud API'),
      'description' => t('Allows user to configure Acquia Cloud API connectivity'),
    ),
    'add domains cloud api' => array(
      'title' => t('Add Domains on Cloud API'),
      'description' => t('Allows user to add domains on to Acquia Cloud'),
    ),
    'delete domains cloud api' => array(
      'title' => t('Delete Domains on Cloud API'),
      'description' => t('Allows user to delete domains on to Acquia Cloud'),
    ),
  );
}

/**
 * Acquia Cloud API settings form.
 * @return array
 */
function acquia_cloud_api_configure_form() {
  $form = array();
  $form['acquia_cloud_username'] = array(
    '#type' => 'textfield',
    '#title' => t('Acquia Cloud Username'),
    '#default_value' => variable_get('acquia_cloud_username', ''),
    '#description' => t('Enter your cloud username as shown on http://network.acquia.com'),
    '#size' => '40',
    '#required' => TRUE,
  );

  $form['acquia_cloud_password'] = array(
    '#type' => 'textfield',
    '#title' => t('Acquia Cloud Username'),
    '#default_value' => variable_get('acquia_cloud_password', ''),
    '#description' => t('Enter your cloud username as shown on http://network.acquia.com'),
    '#size' => '40',
    '#required' => TRUE,
  );

  return system_settings_form($form);
}

function acquia_cloud_api_configure_add_domain_form($form_state, $form, $site_name, $env) {
  $form = array();
  $form['acquia_cloud_domain_site'] = array(
    '#type' => 'textfield',
    '#title' => t('Acquia Cloud Site'),
    '#default_value' => $site_name,
    '#size' => '40',
    '#required' => TRUE,
    '#disabled' => TRUE,
  );
  $form['acquia_cloud_domain_env'] = array(
    '#type' => 'textfield',
    '#title' => t('Acquia Cloud Environment'),
    '#default_value' => $env,
    '#size' => '40',
    '#required' => TRUE,
    '#disabled' => TRUE,
  );
  $form['acquia_cloud_domain_domain'] = array(
    '#type' => 'textfield',
    '#title' => t('Domain Name to be added'),
    '#size' => '40',
    '#required' => TRUE,
  );

  $form['acquia_cloud_domain_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Add Domain')
  );


  return $form;
}

function acquia_cloud_api_configure_delete_domain_form($form_state, $form, $site_name, $env,$domain) {
  $form = array();
  $form['acquia_cloud_domain_site'] = array(
    '#type' => 'textfield',
    '#title' => t('Acquia Cloud Site'),
    '#default_value' => $site_name,
    '#size' => '40',
    '#required' => TRUE,
    '#disabled' => TRUE,
  );
  $form['acquia_cloud_domain_env'] = array(
    '#type' => 'textfield',
    '#title' => t('Acquia Cloud Environment'),
    '#default_value' => $env,
    '#size' => '40',
    '#required' => TRUE,
    '#disabled' => TRUE,
  );
  $form['acquia_cloud_domain_domain'] = array(
    '#type' => 'textfield',
    '#title' => t('Domain Name to be added'),
    '#size' => '40',
    '#default_value' => $domain,
    '#required' => TRUE,
    '#disabled' => TRUE,
  );

  $form['acquia_cloud_domain_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Confirm Deletion of Domain')
  );


  return $form;
}


function acquia_cloud_api_configure_add_domain_form_submit($form, &$form_state) {
  $site_name = $form_state['values']['acquia_cloud_domain_site'];
  $env = $form_state['values']['acquia_cloud_domain_env'];
  $domain_name = $form_state['values']['acquia_cloud_domain_domain'];

  acquia_cloud_curl_caller_post("sites/$site_name/envs/$env/domains/$domain_name");
  drupal_goto('admin/config/cloud-api');
}

function acquia_cloud_api_configure_delete_domain_form_submit($form, &$form_state) {
  $site_name = $form_state['values']['acquia_cloud_domain_site'];
  $env = $form_state['values']['acquia_cloud_domain_env'];
  $domain_name = $form_state['values']['acquia_cloud_domain_domain'];

  acquia_cloud_curl_caller_post("sites/$site_name/envs/$env/domains/$domain_name","DELETE");
  drupal_goto('admin/config/cloud-api');
}

function acquia_cloud_api_report() {
  $report_html = '';
  /**
   * Show Sites info
   */
  $sites_data = acquia_cloud_curl_caller("sites");
  $header = array();
  $rows = array();
  $header[] = array("data" => "Site Name");
  $header[] = array("data" => "Site Information");
  foreach ($sites_data as $key => $value) {
    $site_raw_name = explode(':', $value);
    $site_name = $site_raw_name[1];
    $row = array();
    $row[] = $value;
    /**
     * Get the site info
     */
    $site_info_array = acquia_cloud_curl_caller("sites/$site_name");
    $site_rows = array();
    foreach ($site_info_array as $key => $value) {
      $site_row = array();
      $site_row[] = $key;
      $site_row[] = $value;
      $site_rows[] = $site_row;
    }
    $site_info_table_html = theme('table', array('header' => array('Parameter', 'Value'),
      'rows' => $site_rows));

    /**
     * Get the Site DBs
     */
    $site_databases_array = acquia_cloud_curl_caller("sites/$site_name/dbs");
    $site_dbs = array();
    foreach ($site_databases_array as $key => $value) {
      $site_db_row = array();
      $site_db_row[] = $value['name'];
      $site_dbs[] = $site_db_row;
    }
    $site_dbs_table_html = theme('table', array('header' => array('Databases'),
      'rows' => $site_dbs));

    /**
     * Get the Environments
     */
    $site_envs_array = acquia_cloud_curl_caller("sites/$site_name/envs");
    $site_envs = array();
    foreach ($site_envs_array as $key => $value) {
      $site_env_row = array();
      $env = $value['name'];
      $site_env_row[] = $env;
      /**
       * For each Env, get the domains
       */
      $env_domains_table_html = l(t('Add Domain to this Environment'), "admin/config/cloud-api/add/domain/$site_name/$env");
      $env_domains_array = acquia_cloud_curl_caller("sites/$site_name/envs/$env/domains");
      $env_domains = array();
      foreach ($env_domains_array as $key => $value) {
        $env_domain_row = array();
        $domain_name = $value['name'];
        $env_domain_row[] = $domain_name;
        $env_domain_row[] = l(t('Delete Domain'), "admin/config/cloud-api/delete/domain/$site_name/$env/$domain_name");
        $env_domains[] = $env_domain_row;
      }
      $env_domains_table_html .= theme('table', array('header' => array('Domain', 'Delete'),
        'rows' => $env_domains));

      /**
       * For each Env, get the servers
       */
      $env_servers_array = acquia_cloud_curl_caller("sites/$site_name/envs/$env/servers");
      $env_servers = array();
      foreach ($env_servers_array as $key => $value) {
        $env_server_row = array();
        $server_name = $value['name'];
        $env_server_row[] = $server_name;

        /**
         * Get the server info
         */
        $server_info_array = acquia_cloud_curl_caller("sites/$site_name/envs/$env/servers/$server_name");
        $server_rows = array();
        foreach ($server_info_array as $key => $value) {
          $server_row = array();
          $server_row[] = $key;
          $server_row[] = $value;
          $server_rows[] = $server_row;
        }
        $server_info_table_html = theme('table', array('header' => array('Parameter', 'Value'),
          'rows' => $server_rows));


        $env_server_row[] = $server_info_table_html;
        $env_servers[] = $env_server_row;
      }
      $env_servers_table_html = theme('table', array('header' => array('Server', 'Server Info'),
        'rows' => $env_servers));


      $site_env_row[] = $env_domains_table_html . $env_servers_table_html;
      $site_envs[] = $site_env_row;
    }
    $site_envs_table_html = theme('table', array('header' => array('Environment', 'Environment Details'),
      'rows' => $site_envs));



    /**
     * Get Task List for Site
     */
    $task_list_raw = acquia_cloud_curl_caller("sites/$site_name/tasks");
    $tasks_array_trimmed = array_reverse(array_slice($task_list_raw, -25));
    $task_rows = array();
    foreach ($tasks_array_trimmed as $key => $value) {
      $task_row = array();
      $task_row[] = date('l jS \of F Y h:i:s A', $value['started']);
      $task_row[] = $value['state'];
      $task_row[] = $value['description'];
      $task_rows[] = $task_row;
    }
    $site_tasks_table_html = theme('table', array('header' => array('Time Started', 'Status', 'Task Details'),
      'rows' => $task_rows));

    /**
     * Join the report
     */
    $row[] = $site_info_table_html . $site_dbs_table_html . $site_envs_table_html . $site_tasks_table_html;

    $rows[] = $row;
  }



  $report_html .= theme('table', array('header' => $header, 'rows' => $rows));

  return $report_html;
}

function acquia_cloud_curl_caller($method) {
  $url = "https://cloudapi.acquia.com/v1/" . $method . ".json";
  //  dsm($url);
  $username = variable_get('acquia_cloud_username', "");
  $password = variable_get('acquia_cloud_password', "");
  $ch = curl_init($url);
  curl_setopt($ch, CURLOPT_USERPWD, "$username:$password");
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  $server_output = curl_exec($ch);
  curl_close($ch);
  $decoded_output = drupal_json_decode($server_output);
  return $decoded_output;
}

function acquia_cloud_curl_caller_post($method,$request = "POST") {
  $url = "https://cloudapi.acquia.com/v1/" . $method . ".json";
  //  dsm($url);
  $username = variable_get('acquia_cloud_username', "");
  $password = variable_get('acquia_cloud_password', "");
  $ch = curl_init();

  curl_setopt($ch, CURLOPT_USERPWD, "$username:$password");

  //set the url, number of POST vars, POST data
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_POST, 0);
  curl_setopt($ch, CURLOPT_POSTFIELDS, array());
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $request);
  
  //execute post
  $result = curl_exec($ch);
  //  dsm($result);
  curl_close($ch);
  drupal_set_message(t('Command Sent to Cloud API'));
}